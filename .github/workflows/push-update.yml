name: Update hosts and sing-box ruleset

on:
  push:
    branches:
      - main
    paths:
      - "**/*.py"
      - "hosts.txt"

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      # Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Set up Python environment
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # Run sort.py to update hosts.txt
      - name: Update hosts.txt
        run: |
          python sort.py

      # Generate temporary rules.json and compile ruleset.srs
      - name: Generate sing-box rulesset
        working-directory: sing-box
        run: |
          # Create temporary rules.json
          TMP_RULES_JSON=$(mktemp)
          python to_ruleset.py ../hosts.txt "$TMP_RULES_JSON"

          # Compile ruleset.srs
          python ruleset_compile.py "$TMP_RULES_JSON" ruleset.srs

          # Remove temporary rules.json
          rm -f "$TMP_RULES_JSON"

      # Commit hosts.txt and ruleset.srs if changed
      - name: Commit updated files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add hosts.txt sing-box/ruleset.srs

          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update hosts.txt and sing-box ruleset"
            git push
          fi


